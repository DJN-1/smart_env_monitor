# ğŸ“¦ modules í´ë”: ë¹Œë“œ ê²°ê³¼ë¬¼(.ko íŒŒì¼ë“¤)ë§Œ ì €ì¥
# ğŸ”¨ ì‹¤ì œ ë¹Œë“œëŠ” drivers í´ë”ì—ì„œ ìˆ˜í–‰

all:
	@echo "âš ï¸  ë¹Œë“œëŠ” drivers í´ë”ì—ì„œ ìˆ˜í–‰í•˜ì„¸ìš”!"
	@echo "    cd ../drivers && make all"
	@echo ""
	@echo "ğŸ“ í˜„ì¬ ë¹Œë“œëœ ëª¨ë“ˆë“¤:"
	@ls -la *.ko 2>/dev/null || echo "    ë¹Œë“œëœ ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤"

clean:
	@echo "ğŸ§¹ ë¹Œë“œ ê²°ê³¼ë¬¼ ì •ë¦¬ ì¤‘..."
	rm -f *.ko *.o *.mod *.mod.c *.symvers *.order
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ!"

# ë¹Œë“œëœ ëª¨ë“ˆ ì„¤ì¹˜ (ë¹Œë“œëŠ” í•˜ì§€ ì•ŠìŒ)
install-oled:
	@if [ -f oled_driver.ko ]; then \
		echo "ğŸ“¦ OLED ë“œë¼ì´ë²„ ì„¤ì¹˜ ì¤‘..."; \
		if lsmod | grep -q oled_driver; then \
			echo "ê¸°ì¡´ ëª¨ë“ˆ ì œê±° ì¤‘..."; \
			sudo rmmod oled_driver; \
		fi; \
		sudo insmod oled_driver.ko; \
		echo "ssd1306 0x3c" | sudo tee /sys/bus/i2c/devices/i2c-1/new_device 2>/dev/null || true; \
		sudo chmod 666 /dev/oled_display 2>/dev/null || true; \
		echo "âœ… OLED ë“œë¼ì´ë²„ ì„¤ì¹˜ ì™„ë£Œ!"; \
	else \
		echo "âŒ oled_driver.koê°€ ì—†ìŠµë‹ˆë‹¤!"; \
		echo "   ë¨¼ì € ë¹Œë“œí•˜ì„¸ìš”: cd ../drivers && make all"; \
	fi

install-hello:
	@if [ -f hello_module.ko ]; then \
		sudo insmod hello_module.ko; \
		echo "âœ… Hello ëª¨ë“ˆ ì„¤ì¹˜ ì™„ë£Œ!"; \
	else \
		echo "âŒ hello_module.koê°€ ì—†ìŠµë‹ˆë‹¤!"; \
		echo "   ë¨¼ì € ë¹Œë“œí•˜ì„¸ìš”: cd ../drivers && make all"; \
	fi

remove-oled:
	sudo rmmod oled_driver 2>/dev/null || echo "OLED ë“œë¼ì´ë²„ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"

remove-hello:
	sudo rmmod hello_module 2>/dev/null || echo "Hello ëª¨ë“ˆì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"

# ë¹Œë“œëœ ëª¨ë“ˆë¡œ í…ŒìŠ¤íŠ¸ (ë¹Œë“œëŠ” í•˜ì§€ ì•ŠìŒ)
test:
	@if [ -f oled_driver.ko ]; then \
		echo "ğŸ§ª ê¸°ì¡´ ë¹Œë“œëœ ëª¨ë“ˆë¡œ í…ŒìŠ¤íŠ¸..."; \
		make install-oled; \
		cd ../tests/day3 && ./oled_test "Test from modules folder!"; \
		echo "ğŸ“‹ ì»¤ë„ ë¡œê·¸:"; \
		dmesg | tail -5; \
	else \
		echo "âŒ ë¹Œë“œëœ ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤!"; \
		echo "   ì „ì²´ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸: cd ../drivers && make test"; \
	fi

info:
	@echo "=== modules í´ë” ì •ë³´ ==="
	@echo "ğŸ“ í˜„ì¬ ìœ„ì¹˜: $(PWD)"
	@echo "ğŸ¯ ìš©ë„: ë¹Œë“œ ê²°ê³¼ë¬¼(.ko) ì €ì¥ì†Œ"
	@echo "ğŸ”¨ ë¹Œë“œ ìœ„ì¹˜: $(PWD)/../drivers"
	@echo ""
	@echo "ğŸ“¦ í˜„ì¬ ëª¨ë“ˆë“¤:"
	@ls -la *.ko 2>/dev/null || echo "    ë¹Œë“œëœ ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤"
	@echo ""
	@echo "ğŸ”„ ë¡œë“œëœ ëª¨ë“ˆë“¤:"
	@lsmod | grep -E "(hello|oled)" || echo "    ë¡œë“œëœ ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤"

help:
	@echo "=== modules í´ë” ì‚¬ìš©ë²• ==="
	@echo "ğŸ”¨ ë¹Œë“œ:           cd ../drivers && make all"
	@echo "ğŸ“¦ OLED ì„¤ì¹˜:      make install-oled"
	@echo "ğŸ“¦ Hello ì„¤ì¹˜:     make install-hello"
	@echo "ğŸ—‘ï¸  ëª¨ë“ˆ ì œê±°:      make remove-oled / remove-hello"
	@echo "ğŸ§ª í…ŒìŠ¤íŠ¸:         make test (ë¹Œë“œëœ ëª¨ë“ˆë¡œ)"
	@echo "ğŸ§¹ ì •ë¦¬:          make clean"
	@echo "â„¹ï¸  ì •ë³´:           make info"

.PHONY: all clean install-oled install-hello remove-oled remove-hello test info help
