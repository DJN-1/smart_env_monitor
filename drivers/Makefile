KERNEL_VERSION := $(shell uname -r)
KERNEL_DIR := /lib/modules/$(KERNEL_VERSION)/build

# í—¤ë” ê²½ë¡œ ì¶”ê°€
EXTRA_CFLAGS += -I$(PWD)/../include

# ì»¤ë„ ëª¨ë“ˆë“¤
obj-m += hello_module.o
obj-m += oled_driver.o

# oled_driver êµ¬ì„± (ê°™ì€ í´ë” + ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬)
oled_driver-objs := oled_i2c_driver.o ../src/display/oled_ssd1306_commands.o

all:
	@echo "=== ì»¤ë„ ëª¨ë“ˆ ë¹Œë“œ ì‹œì‘ ==="
	@echo "ë¹Œë“œ ìœ„ì¹˜: $(PWD)"
	@echo "ì»¤ë„ ë²„ì „: $(KERNEL_VERSION)"
	@echo "ì†ŒìŠ¤ íŒŒì¼ë“¤:"
	@ls -la *.c 2>/dev/null || echo "   âŒ .c íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
	@echo "ë””ìŠ¤í”Œë ˆì´ ë¼ì´ë¸ŒëŸ¬ë¦¬: ../src/display/oled_ssd1306_commands.c"
	@ls -la ../src/display/oled_ssd1306_commands.c 2>/dev/null || echo "   âŒ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤!"
	
	$(MAKE) -C $(KERNEL_DIR) M=$(PWD) modules
	
	@echo "=== ë¹Œë“œ ê²°ê³¼ë¬¼ì„ modules í´ë”ë¡œ ë³µì‚¬ ==="
	mkdir -p ../modules
	cp *.ko ../modules/ 2>/dev/null || true
	@echo "âœ… ë¹Œë“œ ì™„ë£Œ!"

clean:
	$(MAKE) -C $(KERNEL_DIR) M=$(PWD) clean
	rm -f ../modules/*.ko 2>/dev/null || true
	find ../src/display -name "*.o" -delete 2>/dev/null || true

# í…ŒìŠ¤íŠ¸ í”„ë¡œê·¸ë¨ ë¹Œë“œ
test-app:
	@echo "=== í…ŒìŠ¤íŠ¸ í”„ë¡œê·¸ë¨ ë¹Œë“œ ==="
	cd ../tests/day3 && gcc -o oled_test oled_test.c -I../../include
	chmod +x ../tests/day3/oled_test

# ì„¤ì¹˜ ë° í…ŒìŠ¤íŠ¸
install-oled: all
	@if lsmod | grep -q oled_driver; then \
		echo "ê¸°ì¡´ ëª¨ë“ˆ ì œê±° ì¤‘..."; \
		sudo rmmod oled_driver; \
	fi
	sudo insmod ../modules/oled_driver.ko
	@echo "=== I2C ë””ë°”ì´ìŠ¤ ë°”ì¸ë”© ==="
	@if [ ! -e /sys/bus/i2c/devices/i2c-1/1-003c ]; then \
		echo "ssd1306 0x3c" | sudo tee /sys/bus/i2c/devices/i2c-1/new_device; \
	else \
		echo "âš ï¸ ì´ë¯¸ ë°”ì¸ë”©ëœ ë””ë°”ì´ìŠ¤ì…ë‹ˆë‹¤."; \
	fi
	sudo chmod 666 /dev/oled_display 2>/dev/null || true
	@echo "âœ… OLED ë“œë¼ì´ë²„ ì„¤ì¹˜ ì™„ë£Œ!"

remove-oled:
	sudo rmmod oled_driver

test: all test-app install-oled
	@echo "=== ì¢…í•© í…ŒìŠ¤íŠ¸ ì‹œì‘ ==="
	../tests/day3/oled_test "Hello from drivers folder!"
	@echo "=== ì»¤ë„ ë¡œê·¸ í™•ì¸ ==="
	dmesg | tail -10

check:
	@echo "=== íŒŒì¼ êµ¬ì¡° ì ê²€ ==="
	@echo "ğŸ“ í˜„ì¬ ìœ„ì¹˜: $(PWD)"
	@echo "ğŸ“‹ í˜„ì¬ í´ë” .c íŒŒì¼ë“¤:"
	@ls -la *.c 2>/dev/null || echo "   âŒ .c íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
	@echo "ğŸ“‹ ë””ìŠ¤í”Œë ˆì´ ë¼ì´ë¸ŒëŸ¬ë¦¬:"
	@ls -la ../src/display/*.c 2>/dev/null || echo "   âŒ src/display/*.c ì—†ìŒ"
	@echo "ğŸ“‹ í—¤ë” íŒŒì¼ë“¤:"
	@ls -la ../include/*.h 2>/dev/null || echo "   âŒ include/*.h ì—†ìŒ"
	@echo "ğŸ“‹ í…ŒìŠ¤íŠ¸ í”„ë¡œê·¸ë¨:"
	@ls -la ../tests/day3/oled_test* 2>/dev/null || echo "   âŒ tests/day3/oled_test ì—†ìŒ"

info:
	@echo "=== ë¹Œë“œ í™˜ê²½ ì •ë³´ ==="
	@echo "ë¹Œë“œ ìœ„ì¹˜: $(PWD)"
	@echo "ê²°ê³¼ë¬¼ ìœ„ì¹˜: $(PWD)/../modules"
	@echo "í…ŒìŠ¤íŠ¸ ìœ„ì¹˜: $(PWD)/../tests/day3"
	@echo ""
	@echo "=== ë¡œë“œëœ ëª¨ë“ˆ ==="
	lsmod | grep -E "(hello|oled)" || echo "ë¡œë“œëœ ëª¨ë“ˆ ì—†ìŒ"

.PHONY: all clean test-app install-oled remove-oled test check info
